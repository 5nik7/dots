#!/usr/bin/env bash

declare -r esc=$'\033'
declare -r c_reset="${esc}[0m"
declare -r bold="${esc}[1m"
declare -r dim="${esc}[2m"
declare -r italic="${esc}[3m"
declare -r underline="${esc}[4m"
declare -r rev="${esc}[7m"
declare -r fg_black="${esc}[1;30m"
declare -r fg_red="${esc}[1;31m"
declare -r fg_green="${esc}[1;32m"
declare -r fg_yellow="${esc}[1;33m"
declare -r fg_darkblue="${esc}[0;34m"
declare -r fg_blue="${esc}[1;34m"
declare -r fg_magenta="${esc}[1;35m"
declare -r fg_cyan="${esc}[1;36m"
declare -r fg_white="${esc}[1;37m"
declare -r trashico=""
declare -r arrowico="<-"
declare -r arrowcolor="${fg_black}"
declare -r errico=""
declare -t errcolor="${fg_red}"
declare -r warnico=""
declare -t warncolor="${fg_yellow}"

declare -r trashcolor="${fg_green}"
declare -r dircolor="${fg_darkblue}"

BOLD="$(tput bold 2>/dev/null || printf '')"
UNDERLINE="$(tput smul 2>/dev/null || printf '')"
ITALIC="$(tput sitm 2>/dev/null || printf '')"
DIM="$(tput dim 2>/dev/null || printf '')"
INVERT="$(tput rev 2>/dev/null || printf '')"
BLINK="$(tput blink 2>/dev/null || printf '')"
INVIS="$(tput invis 2>/dev/null || printf '')"
GREY="$(tput setaf 7 2>/dev/null || printf '')"
BLACK="$(tput setaf 8 2>/dev/null || printf '')"
RED="$(tput setaf 1 2>/dev/null || printf '')"
GREEN="$(tput setaf 2 2>/dev/null || printf '')"
YELLOW="$(tput setaf 3 2>/dev/null || printf '')"
BLUE="$(tput setaf 4 2>/dev/null || printf '')"
DARKBLUE="$(tput setaf 12 2>/dev/null || printf '')"
MAGENTA="$(tput setaf 5 2>/dev/null || printf '')"
CYAN="$(tput setaf 6 2>/dev/null || printf '')"
NO_COLOR="$(tput sgr0 2>/dev/null || printf '')"

error() {
  printf ' %s\n' "${errcolor}${errico} $*${c_reset}" >&2
}

warn() {
  printf ' %s\n' "${warncolor}${warnico} $*${NO_COLOR}"
}

info() {
  printf ' %s\n' "${GREY}${DIM}$*${NO_COLOR}"
}

disc() {
  printf ' %s\n' "${GREEN}$*${NO_COLOR}"
}

logo() {
  echo "${MAGENTA}$*${NO_COLOR}"
}

flag() {
  printf "  %-28s %s\n" "${BOLD}${CYAN}$1${NO_COLOR}" " ${GREEN}$2${NO_COLOR}"
}

usage() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
    header)
      local header="
 █▀▀▀▄ █▀▀▀▀ █▀▄▀█ ▄▀▀▀▄ █   █ █▀▀▀▀
 █▀▀▀▄ █▀▀   █   █ █   █  █ █  █▀▀
 ▀   ▀ ▀▀▀▀▀ ▀   ▀  ▀▀▀    ▀   ▀▀▀▀▀"
      logo "${header}"
      disc "Utility for deleting files"
      info "usage:${NO_COLOR} ${MAGENTA}${BOLD}remove${NO_COLOR} ${CYAN}[options]${NO_COLOR} ${BLUE}<file|dir>${NO_COLOR} ${BLUE}${DIM}[more files/dirs...]${NO_COLOR}"
      echo
      break
      ;;
    esac
  done
  info "Options:"
  flag "-h, --help" "Displays help"
  flag "-b, --backup" "Place backups into ~/.bakstore"
  echo
}

rmed() {
  local targetpath targetdir targetname
  targetpath="$1"
  targetdir="$(dirname "$targetpath" | sed "s|^${HOME}|~|")"
  targetname="$(basename "$targetpath")"
  printf " ${trashcolor}${trashico}${c_reset}${arrowcolor} ${arrowico}${c_reset} ${targeticon} ${dircolor}%s${targetcolor}${bold}%s${c_reset}\n" "$targetdir/" "$targetname"
  command rm -fr "$targetpath"
}

main() {
  # No args?
  [ "$#" -gt 0 ] || {
    usage header
    return 1
  }

  local backup=0
  local args=()

  while [ "$#" -gt 0 ]; do
    case "$1" in
    -h | --help)
      usage header
      return 0
      ;;
    --)
      shift
      args+=("$@")
      break
      ;;
    -b | --backup) backup=1 ;;
    -*)
      error "unknown option '${1}"
      usage
      return 1
      ;;
    *) args+=("$1") ;;
    esac
    shift
  done

  [ "${#args[@]}" -gt 0 ] || {
    usage header
    return 1
  }

  for src in "${args[@]}"; do
    local targetpath targetdir targetname
    targetpath=$(realpath "$src")
    targetdir=$(dirname "$targetpath" | sed "s|^${HOME}|~|")
    targetname=$(basename "$targetpath")

    if [ ! -e "$targetpath" ]; then
      error " ${fg_magenta}${targetdir}/${bold}$targetname${c_reset}${fg_red} does not exist"
      continue
    fi

    if [ "$backup" -eq 1 ]; then
      bak -s -y "$targetpath"
    fi

    local targetcolor targetico
    if [ -f "$targetpath" ]; then
      targetcolor="${c_reset}"
      targeticon="󰡯"
    fi
    if [ -d "$targetpath" ]; then
      targetcolor="${fg_blue}"
      targeticon="${fg_darkblue}${c_reset}"
    fi
    printf " ${trashcolor}${trashico}${c_reset}${arrowcolor} ${arrowico}${c_reset} ${targeticon} ${dircolor}%s${targetcolor}${bold}%s${c_reset}\n" "$targetdir/" "$targetname"
    rm -fr -- "$targetpath"
  done
}

echo
main "$@"
echo
